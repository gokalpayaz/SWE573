{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h2>Create a new blog post</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="mb-3">
      <label for="title" class="form-label">Title</label>
      <input type="text" class="form-control" id="title" name="title" required>
    </div>

    <div class="mb-3">
      <label for="text" class="form-label">Text</label>
      <textarea class="form-control" id="text" name="text" rows="5" required></textarea>
    </div>

    <div class="mb-3">
      <label for="tags" class="form-label">Tags</label>
      <select class="form-select" id="tags" name="tags" multiple>
        {% for tag in tags %}
        <option value="{{ tag.id }}">{{ tag.tag }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="imageUpload" class="form-label">Upload Image</label>
      <input class="form-control" type="file" id="imageUpload" name="imageUpload[]" accept="image/*" multiple>
      <div id="imagePreviewContainer" class="row mt-3"></div>
    </div>

    <!-- Map Section -->
    <div class="mb-3">
      <label for="location" class="form-label">Select Location:</label>
      <div id="map" style="width: 100%; height: 300px"></div>
      <input type="hidden" id="location-name" name="location-name">
      <input type="hidden" id="location-point" name="location-point">
    </div>

    <!-- Search bar and Radius Section -->
    <div class="row mb-3">
      <div class="col">
        <label for="radius" class="form-label">Radius (meters):</label>
        <input type="range" class="form-range" id="radius" name="radius" min="100" max="1000" step="100" value="500">
        <span id="radius-value">500</span> meters
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
</div>

<script>
  window.addEventListener('DOMContentLoaded', function () {
    function initMap() {
      var map = L.map('map', {
        center: [51.505, -0.09],
        zoom: 13,
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var geocoder = L.Control.Geocoder.nominatim();
      var control = L.Control.geocoder({
        geocoder: geocoder,
        defaultMarkGeocode: false,
      }).addTo(map);

      control.on('markgeocode', function (e) {
        map.setView(e.geocode.center, 16);
        // Your code to set the default radius when a location is found

        // Set the location name field value
        document.getElementById('location-name').value = e.geocode.name;

        // Set the location point field value
        document.getElementById('location-point').value = e.geocode.center.lat + ',' + e.geocode.center.lng;
      });

      // Declare a variable to store the marker
      let marker;
      let locationName;
      let locationPoint;

      // Add a click event listener to the map
      map.on('click', function (event) {
        const clickedLocation = event.latlng;

        // Remove the previous marker if it exists
        if (marker) {
          map.removeLayer(marker);
        }

        // Add a new marker to the clicked location
        marker = L.marker(clickedLocation).addTo(map);

      // Update the location information
        locationName = '';
        locationPoint = clickedLocation;
        
        // Update the map view
        map.setView(clickedLocation, map.getZoom());
        // console.log(clickedLocation.lat+ ',' +clickedLocation.lng)
        // Set the value of the location input element
        document.getElementById('location-point').value = clickedLocation.lat+ ',' +clickedLocation.lng;
        console.log(document.getElementById('location-point').value)
      });
    }

    initMap();


    // Update radius value display and input element value
    var radiusSlider = document.getElementById('radius');
    var radiusValue = document.getElementById('radius-value');
    radiusSlider.addEventListener('input', function () {
      radiusValue.textContent = radiusSlider.value;
      radiusSlider.setAttribute('value', radiusSlider.value);
    });
  });

  // Listen for changes on the file input
  document.getElementById('imageUpload').addEventListener('change', function (event) {
    var imagePreviewContainer = document.getElementById('imagePreviewContainer');
    var files = event.target.files;

    // Remove previous image previews
    imagePreviewContainer.innerHTML = '';

    for (var i = 0; i < files.length; i++) {
      var file = files[i];

      if (file) {
        var reader = new FileReader();
        reader.onload = (function (fileIndex) {
          return function (e) {
            var imagePreview = document.createElement('img');
            imagePreview.src = e.target.result;
            imagePreview.alt = 'Image Preview';
            imagePreview.className = 'img-fluid col-md-4 mt-3';

            imagePreviewContainer.appendChild(imagePreview);
          };
        })(i);
        reader.readAsDataURL(file);
      }
    }
  });

</script>
{% endblock %}